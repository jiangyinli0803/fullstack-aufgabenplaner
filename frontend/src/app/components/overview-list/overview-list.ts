import { Component } from '@angular/core';
import { Task } from '../../models/task.model';
import { Employee } from '../../models/employee.model';
import { TaskService } from '../../services/task.service';
import { EmployeeService } from '../../services/employee.service';
import { CommonModule } from '@angular/common';
import { Router, RouterModule } from '@angular/router';
import { FormsModule } from '@angular/forms';

@Component({
  selector: 'app-overview-list',
  standalone: true,
  imports: [CommonModule, RouterModule, FormsModule],
  templateUrl: './overview-list.html',
  styleUrl: './overview-list.css',
})
export class OverviewList {
  tasks: Task[] = [];
  employees: Employee[] = [];
  selectedDepartment: string = 'alle';
  departments: string[] = [];
 //é‡æ–°å®šä¹‰ä¸€ä¸ªç»„åˆæ•°ç»„
  tasksWithEmployeesAndDuration: (Task & {duration?:number; employeeName?: string; employeeDepartment?: string })[] = [];

  constructor( 
    private router: Router,  
    private taskService: TaskService,
    private employeeService: EmployeeService
  ) {}

  ngOnInit() {
    // å…ˆåŠ è½½å‘˜å·¥æ•°æ®
    this.employees = this.employeeService.getCurrentEmployees();
    this.tasks = this.taskService.getCurrentTasks();

    this.departments = [
      'alle',
      ...new Set(this.employees.map(e => e.department))
    ];

    this.combineTasksWithEmployeesAndDuration();
       
  }

  private combineTasksWithEmployeesAndDuration() {
       // âœ… å…³é”®:å°† map çš„ç»“æžœèµ‹å€¼ç»™å˜é‡
      this.tasksWithEmployeesAndDuration = this.tasks.map(task => {
      const employee = this.employees.find(e => e.id === task.employeeId);
      const duration =this.taskService.calculateDuration(task.startDate, task.endDate);

      // ðŸ” è°ƒè¯•ï¼šæ£€æŸ¥å“ªäº›ä»»åŠ¡ duration ä¸ºç©º
      if (duration === undefined) {
        console.log('Duration è®¡ç®—å¤±è´¥:', task);
      }
    
      return {
        ...task,
        duration,
        employeeName: employee?.name || '-',
        employeeDepartment: employee?.department || '-'
      };
    });
  }

     // ðŸ”¥ AUTOMATISCH aktualisierte Filterliste
 get filteredTasksbyDepartment(){
    if(this.selectedDepartment === 'alle'){
      return this.tasksWithEmployeesAndDuration;
    }
    return this.tasksWithEmployeesAndDuration.filter(t => t.employeeDepartment === this.selectedDepartment);
  }

   viewTaskDetail(taskId: number){
    this.router.navigate(['/tasks', 'detail', taskId]);
  }

}
